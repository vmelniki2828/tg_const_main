# Инструкция по исправлению дублирующих промокодов

## Проблема
У некоторых пользователей выдалось по несколько промокодов за один и тот же период времени (например, два промокода за 7 дней).

## Решение

### 1. Автоматическая очистка через API (рекомендуется)

Используйте эндпоинт для очистки дубликатов:

**Для конкретного бота:**
```bash
POST /api/cleanup-duplicate-promocodes/:botId
```

**Для всех ботов:**
```bash
POST /api/cleanup-duplicate-promocodes-all
```

Эндпоинт:
- Находит все дублирующие промокоды
- Оставляет самый ранний промокод (по дате активации)
- Деактивирует остальные дубликаты (не удаляет, сохраняет историю)

### 2. Ручная очистка через скрипт

Запустите скрипт:
```bash
node backend/fix-duplicate-promocodes.js
```

Скрипт автоматически:
- Найдет все дубликаты
- Оставит первый промокод (самый ранний)
- Деактивирует остальные

## Что было исправлено в коде

### 1. Улучшена проверка перед выдачей промокода
- Теперь проверяется **оба места**: `LoyaltyPromoCode` и `User.loyaltyRewards`
- Это предотвращает выдачу дубликатов

### 2. Атомарная активация промокода
- Используется `findOneAndUpdate` вместо `findOne` + `updateOne`
- Это предотвращает race condition (когда два процесса одновременно выдают промокод)

### 3. Дополнительная проверка после активации
- После активации промокода проверяется, нет ли другого промокода за тот же период
- Если найден дубликат, новый промокод деактивируется

### 4. Улучшена обработка ошибок
- При ошибке отправки промокод деактивируется
- Это позволяет попробовать отправить снова при следующей проверке

## Как использовать

### Вариант 1: Через API (из интерфейса или curl)

```bash
# Очистить дубликаты для конкретного бота
curl -X POST http://localhost:3001/api/cleanup-duplicate-promocodes/1757499905687

# Очистить дубликаты для всех ботов
curl -X POST http://localhost:3001/api/cleanup-duplicate-promocodes-all
```

### Вариант 2: Через скрипт

```bash
cd backend
node fix-duplicate-promocodes.js
```

## Результат

После очистки:
- У каждого пользователя останется только один промокод за каждый период
- Дубликаты будут деактивированы (не удалены, для истории)
- В будущем дубликаты не будут выдаваться благодаря улучшенной логике проверки

