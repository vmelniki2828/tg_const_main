#!/bin/bash

echo "üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —Å –≤–Ω–µ—à–Ω–µ–π MongoDB –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—É—é..."

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã
echo "‚èπÔ∏è –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã..."
docker compose down

# –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ MongoDB
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é MongoDB..."
docker compose up -d mongodb

# –ñ–¥–µ–º, –ø–æ–∫–∞ MongoDB –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è
echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ MongoDB..."
sleep 30

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ MongoDB –∑–∞–ø—É—Å—Ç–∏–ª–∞—Å—å
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å MongoDB..."
docker compose exec mongodb mongosh --eval "db.adminCommand('ping')" || {
    echo "‚ùå MongoDB –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª–∞—Å—å!"
    exit 1
}

echo "‚úÖ MongoDB –∑–∞–ø—É—â–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"

# –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ —Å –≤–Ω–µ—à–Ω–µ–π MongoDB (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞)
echo "üì§ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ —Å –≤–Ω–µ—à–Ω–µ–π MongoDB..."
if command -v mongodump &> /dev/null; then
    echo "üì• –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é —Å –≤–Ω–µ—à–Ω–µ–π MongoDB..."
    mongodump --uri="mongodb://157.230.20.252:27017/tg_const_main" --out=./mongo-backup-$(date +%Y%m%d_%H%M%S) || {
        echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é —Å –≤–Ω–µ—à–Ω–µ–π MongoDB (–≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞)"
    }
else
    echo "‚ö†Ô∏è mongodump –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ"
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã..."
docker compose up -d

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ backend
echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ backend..."
sleep 20

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤..."
docker compose ps

echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo "üåê –§—Ä–æ–Ω—Ç–µ–Ω–¥: http://157.230.20.252:3000"
echo "üîß API: http://157.230.20.252:3001"
echo "üóÑÔ∏è MongoDB: localhost:27017"
echo ""
echo "üìä –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:"
echo "docker compose exec mongodb mongosh tg_const_main --eval 'db.bots.find().count()'"
